<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宇宙点状文明体系总体状态二维模拟器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: radial-gradient(ellipse at center, #0f0f23 0%, #000000 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .universe-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            height: 100vh;
            gap: 20px;
        }

        .control-panel {
            background: rgba(15, 15, 35, 0.9);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px 20px;
            overflow-y: auto;
            backdrop-filter: blur(10px);
        }

        .simulation-space {
            position: relative;
            background: radial-gradient(circle at 30% 20%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 80%, rgba(255, 119, 198, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 70%, rgba(119, 198, 255, 0.1) 0%, transparent 50%);
            overflow: hidden;
        }

        .title {
            font-size: 2.5rem;
            font-weight: 300;
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(45deg, #64b5f6, #81c784, #ffb74d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
        }

        .parameter-group {
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .parameter-group h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: #81c784;
            font-weight: 500;
        }

        .parameter {
            margin-bottom: 15px;
        }

        .parameter label {
            display: block;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #b0b0b0;
        }

        .parameter input[type="range"] {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            outline: none;
            -webkit-appearance: none;
        }

        .parameter input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            background: #64b5f6;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(100, 181, 246, 0.5);
        }

        .parameter-value {
            display: inline-block;
            min-width: 50px;
            text-align: right;
            color: #64b5f6;
            font-weight: 500;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            background: linear-gradient(45deg, #64b5f6, #42a5f5);
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(100, 181, 246, 0.4);
        }

        .btn.danger {
            background: linear-gradient(45deg, #ef5350, #f44336);
        }

        .canvas-container {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        #universe-canvas {
            width: 100%;
            height: 100%;
            background: transparent;
        }

        .stats-overlay {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .stat-label {
            color: #b0b0b0;
        }

        .stat-value {
            color: #64b5f6;
            font-weight: 500;
            min-width: 60px;
            text-align: right;
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 10px;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .pulsing {
            animation: pulse 2s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="universe-container">
        <div class="control-panel">
            <h1 class="title">宇宙文明<br>演化模拟器</h1>
            
            <div class="parameter-group">
                <h3>基础参数</h3>
                <div class="parameter">
                    <label for="density">文明密度</label>
                    <input type="range" id="density" min="0.1" max="5" step="0.1" value="1">
                    <span class="parameter-value" id="density-value">1.0</span>
                </div>
                <div class="parameter">
                    <label for="evolution-speed">进化速度</label>
                    <input type="range" id="evolution-speed" min="0.1" max="3" step="0.1" value="1">
                    <span class="parameter-value" id="evolution-speed-value">1.0</span>
                </div>
            </div>

            <div class="parameter-group">
                <h3>通信与移动</h3>
                <div class="parameter">
                    <label for="comm-distance">通信距离</label>
                    <input type="range" id="comm-distance" min="50" max="300" step="10" value="100">
                    <span class="parameter-value" id="comm-distance-value">100</span>
                </div>
            </div>

            <div class="parameter-group">
                <h3>社会因素</h3>
                <div class="parameter">
                    <label for="extinction-prob">灭绝概率</label>
                    <input type="range" id="extinction-prob" min="0" max="0.01" step="0.001" value="0.002">
                    <span class="parameter-value" id="extinction-prob-value">0.002</span>
                </div>
                <div class="parameter">
                    <label for="moral-level">道德水平</label>
                    <input type="range" id="moral-level" min="0" max="1" step="0.1" value="0.5">
                    <span class="parameter-value" id="moral-level-value">0.5</span>
                </div>
                <div class="parameter">
                    <label for="foreign-prob">外来文明路过概率</label>
                    <input type="range" id="foreign-prob" min="0" max="0.05" step="0.001" value="0.01">
                    <span class="parameter-value" id="foreign-prob-value">0.010</span>
                </div>
            </div>

            <div class="controls">
                <button class="btn" id="start-btn">启动</button>
                <button class="btn" id="pause-btn">暂停</button>
                <button class="btn danger" id="reset-btn">重置</button>
            </div>
        </div>

        <div class="simulation-space">
            <div class="canvas-container">
                <canvas id="universe-canvas"></canvas>
            </div>

            <div class="stats-overlay">
                <div class="stat-item">
                    <span class="stat-label">文明总数</span>
                    <span class="stat-value" id="total-civs">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">平均等级</span>
                    <span class="stat-value" id="avg-level">0.0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">通信连接</span>
                    <span class="stat-value" id="connections">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">活跃飞船</span>
                    <span class="stat-value" id="active-ships">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">模拟时间</span>
                    <span class="stat-value" id="sim-time">0</span>
                </div>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #4fc3f7;"></div>
                    <span>原始文明 (0-1级)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #81c784;"></div>
                    <span>行星文明 (1-2级)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffb74d;"></div>
                    <span>恒星文明 (2-3级)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f06292;"></div>
                    <span>银河文明 (3级+)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: rgba(255,255,255,0.3);"></div>
                    <span>通信连接</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        class Civilization {
            constructor(x, y, isForeign = false) {
                this.x = x;
                this.y = y;
                this.level = Math.random() * 0.5; // 0-3级文明
                this.age = 0;
                this.alive = true;
                this.connections = [];
                this.ships = [];
                this.morality = Math.random();
                this.isForeign = isForeign; // 标记是否为外来文明
            }

            update(params) {
                if (!this.alive) return;

                this.age++;
                
                // 进化
                this.level += params.evolutionSpeed * 0.001 * (1 + this.connections.length * 0.1);
                
                // 灭绝概率检查（道德水平低时毁灭其他文明的概率上升）
                const moralityFactor = 1 - this.morality * 0.5;
                const destructionFactor = (1 - this.morality) * 2; // 道德越低，毁灭因子越高
                if (Math.random() < params.extinctionProb * moralityFactor) {
                    this.alive = false;
                    // 清除飞船轨迹
                    this.ships.forEach(ship => {
                        ship.trail = [];
                    });
                    return;
                }

                // 发射飞船（不同文明飞船速度不同）
                if (this.level > 1 && Math.random() < 0.01 * this.level) {
                    this.launchShip();
                }

                // 更新飞船
                this.ships = this.ships.filter(ship => ship.update(params, this));
            }

            launchShip() {
                const angle = Math.random() * Math.PI * 2;
                // 飞船速度根据文明等级和随机因素决定
                const speed = 0.2 + Math.random() * 0.8 + this.level * 0.2;
                this.ships.push(new Ship(this.x, this.y, angle, speed, this));
            }

            getColor() {
                if (!this.alive) return '#333333';
                
                if (this.level < 1) return '#4fc3f7';
                else if (this.level < 2) return '#81c784';
                else if (this.level < 3) return '#ffb74d';
                else return '#f06292';
            }

            getSize() {
                return Math.max(2, Math.min(8, 2 + this.level * 2));
            }
        }

        class Ship {
            constructor(x, y, angle, speed, owner) {
                this.x = x;
                this.y = y;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.life = 1000;
                this.owner = owner;
                this.target = null;
                this.trail = []; // 添加轨迹存储
                this.maxTrailLength = 50; // 最大轨迹长度
                this.level = owner.level; // 飞船等级继承自拥有者
            }

            update(params, owner) {
                // 更新轨迹
                this.trail.push({x: this.x, y: this.y});
                if (this.trail.length > this.maxTrailLength) {
                    this.trail.shift(); // 移除最旧的轨迹点
                }

                this.x += this.vx;
                this.y += this.vy;
                this.life--;

                // 检查是否离开画布
                if (this.x < 0 || this.x > window.simulator.canvas.width || 
                    this.y < 0 || this.y > window.simulator.canvas.height) {
                    return false;
                }

                // 飞船可以改变目的地
                if (Math.random() < 0.001) {
                    this.changeTarget();
                }

                // 检查是否到达目标
                if (this.target && this.checkArrival()) {
                    // 占据新据点或毁灭文明
                    if (Math.random() < 0.7) { // 70%概率占据据点
                        this.occupyTarget();
                    } else { // 30%概率毁灭文明
                        this.destroyTarget();
                    }
                    return false;
                }

                return this.life > 0;
            }

            changeTarget() {
                // 随机选择一个新目标
                const aliveCivs = window.simulator.civilizations.filter(civ => civ.alive && civ !== this.owner);
                if (aliveCivs.length > 0) {
                    this.target = aliveCivs[Math.floor(Math.random() * aliveCivs.length)];
                    
                    // 重新计算方向向量
                    const dx = this.target.x - this.x;
                    const dy = this.target.y - this.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    // 保持原有速度大小，只改变方向
                    const speed = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                    this.vx = (dx / distance) * speed;
                    this.vy = (dy / distance) * speed;
                }
            }

            checkArrival() {
                if (!this.target) return false;
                
                const distance = Math.sqrt(
                    Math.pow(this.x - this.target.x, 2) + 
                    Math.pow(this.y - this.target.y, 2)
                );
                
                return distance < 5; // 当距离小于5像素时认为到达
            }

            occupyTarget() {
                if (!this.target) return;
                
                // 占据目标据点并继续发展
                this.target.level = Math.max(this.target.level, this.owner.level * 0.8);
                this.target.alive = true; // 灭绝的文明被占据后复活
            }

            destroyTarget() {
                if (!this.target) return;
                
                // 毁灭目标文明
                this.target.alive = false;
                // 清除目标文明的飞船轨迹
                this.target.ships.forEach(ship => {
                    ship.trail = [];
                });
                this.target.ships = [];
            }

            getColor() {
                if (this.level < 1) return '#4fc3f7';
                else if (this.level < 2) return '#81c784';
                else if (this.level < 3) return '#ffb74d';
                else return '#f06292';
            }
        }

        class UniverseSimulator {
            constructor() {
                this.canvas = document.getElementById('universe-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.civilizations = [];
                this.running = false;
                this.time = 0;
                window.simulator = this; // 使模拟器全局可访问，供Ship类使用
                
                this.params = {
                    density: 1.0,
                    evolutionSpeed: 1.0,
                    commDistance: 100,
                    extinctionProb: 0.002,
                    moralLevel: 0.5,
                    foreignProb: 0.01
                };

                this.setupCanvas();
                this.setupControls();
                this.generateCivilizations();
                this.animate();
            }

            setupCanvas() {
                const resize = () => {
                    this.canvas.width = this.canvas.offsetWidth;
                    this.canvas.height = this.canvas.offsetHeight;
                };
                resize();
                window.addEventListener('resize', resize);
            }

            setupControls() {
                // 参数控制
                const paramInputs = ['density', 'evolution-speed', 'comm-distance', 'extinction-prob', 'moral-level', 'foreign-prob'];
                paramInputs.forEach(id => {
                    const input = document.getElementById(id);
                    const valueSpan = document.getElementById(id + '-value');
                    
                    input.addEventListener('input', () => {
                        const value = parseFloat(input.value);
                        valueSpan.textContent = value.toFixed(id.includes('prob') ? 3 : 1);
                        
                        const paramMap = {
                            'density': 'density',
                            'evolution-speed': 'evolutionSpeed',
                            'comm-distance': 'commDistance',
                            'extinction-prob': 'extinctionProb',
                            'moral-level': 'moralLevel',
                            'foreign-prob': 'foreignProb'
                        };
                        
                        this.params[paramMap[id]] = value;
                        
                        if (id === 'density') {
                            this.generateCivilizations();
                        }
                    });
                    
                    // 初始化显示
                    input.dispatchEvent(new Event('input'));
                });

                // 控制按钮
                document.getElementById('start-btn').addEventListener('click', () => {
                    this.running = true;
                });

                document.getElementById('pause-btn').addEventListener('click', () => {
                    this.running = false;
                });

                document.getElementById('reset-btn').addEventListener('click', () => {
                    this.running = false;
                    this.time = 0;
                    this.generateCivilizations();
                });
            }

            generateCivilizations() {
                this.civilizations = [];
                const count = Math.floor(this.params.density * 50);
                
                for (let i = 0; i < count; i++) {
                    const x = Math.random() * this.canvas.width;
                    const y = Math.random() * this.canvas.height;
                    this.civilizations.push(new Civilization(x, y));
                }
            }

            updateConnections() {
                // 清除旧连接
                this.civilizations.forEach(civ => civ.connections = []);

                // 计算新连接
                for (let i = 0; i < this.civilizations.length; i++) {
                    for (let j = i + 1; j < this.civilizations.length; j++) {
                        const civ1 = this.civilizations[i];
                        const civ2 = this.civilizations[j];
                        
                        if (!civ1.alive || !civ2.alive) continue;
                        
                        const distance = Math.sqrt(
                            Math.pow(civ1.x - civ2.x, 2) + 
                            Math.pow(civ1.y - civ2.y, 2)
                        );
                        
                        const commRange = this.params.commDistance * Math.min(civ1.level, civ2.level);
                        
                        if (distance < commRange && civ1.level > 0.5 && civ2.level > 0.5) {
                            civ1.connections.push(civ2);
                            civ2.connections.push(civ1);
                        }
                    }
                }
            }

            update() {
                if (!this.running) return;

                this.time++;
                
                // 更新文明
                this.civilizations.forEach(civ => civ.update(this.params));
                
                // 更新连接
                this.updateConnections();
                
                // 随机生成新文明
                if (Math.random() < this.params.density * 0.001) {
                    const x = Math.random() * this.canvas.width;
                    const y = Math.random() * this.canvas.height;
                    this.civilizations.push(new Civilization(x, y));
                }
                
                // 随机生成外来文明飞船
                if (Math.random() < this.params.foreignProb) {
                    // 从画布边缘随机位置生成外来文明飞船
                    const side = Math.floor(Math.random() * 4);
                    let x, y;
                    
                    switch(side) {
                        case 0: // 上边
                            x = Math.random() * this.canvas.width;
                            y = 0;
                            break;
                        case 1: // 右边
                            x = this.canvas.width;
                            y = Math.random() * this.canvas.height;
                            break;
                        case 2: // 下边
                            x = Math.random() * this.canvas.width;
                            y = this.canvas.height;
                            break;
                        case 3: // 左边
                            x = 0;
                            y = Math.random() * this.canvas.height;
                            break;
                    }
                    
                    const foreignCiv = new Civilization(x, y, true);
                    foreignCiv.level = 2 + Math.random() * 1.5; // 外来文明等级较高
                    this.civilizations.push(foreignCiv);
                    foreignCiv.launchShip();
                }

                this.updateStats();
            }

            updateStats() {
                const aliveCivs = this.civilizations.filter(civ => civ.alive);
                const avgLevel = aliveCivs.length > 0 ? 
                    aliveCivs.reduce((sum, civ) => sum + civ.level, 0) / aliveCivs.length : 0;
                
                const totalConnections = aliveCivs.reduce((sum, civ) => sum + civ.connections.length, 0) / 2;
                const totalShips = aliveCivs.reduce((sum, civ) => sum + civ.ships.length, 0);

                document.getElementById('total-civs').textContent = aliveCivs.length;
                document.getElementById('avg-level').textContent = avgLevel.toFixed(2);
                document.getElementById('connections').textContent = Math.floor(totalConnections);
                document.getElementById('active-ships').textContent = totalShips;
                document.getElementById('sim-time').textContent = Math.floor(this.time / 60);
            }

            render() {
                // 清除画布但保留淡出效果（透明度设为更高以加快清除）
                this.ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

                // 绘制连接
                this.ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
                this.ctx.lineWidth = 1;
                this.civilizations.forEach(civ => {
                    if (!civ.alive) return;
                    civ.connections.forEach(other => {
                        if (civ.x < other.x) { // 避免重复绘制
                            this.ctx.beginPath();
                            this.ctx.moveTo(civ.x, civ.y);
                            this.ctx.lineTo(other.x, other.y);
                            this.ctx.stroke();
                        }
                    });
                });

                // 绘制飞船轨迹
                this.ctx.lineWidth = 1;
                this.civilizations.forEach(civ => {
                    civ.ships.forEach(ship => {
                        if (ship.trail.length > 1) {
                            this.ctx.strokeStyle = ship.getColor() + '40'; // 使用飞船颜色绘制轨迹
                            this.ctx.beginPath();
                            this.ctx.moveTo(ship.trail[0].x, ship.trail[0].y);
                            for (let i = 1; i < ship.trail.length; i++) {
                                this.ctx.lineTo(ship.trail[i].x, ship.trail[i].y);
                            }
                            this.ctx.stroke();
                        }
                    });
                });

                // 绘制文明
                this.civilizations.forEach(civ => {
                    if (!civ.alive) return;
                    
                    this.ctx.fillStyle = civ.getColor();
                    this.ctx.beginPath();
                    this.ctx.arc(civ.x, civ.y, civ.getSize(), 0, Math.PI * 2);
                    this.ctx.fill();

                    // 通信范围指示（高级文明）
                    if (civ.level > 2) {
                        this.ctx.strokeStyle = civ.getColor() + '20';
                        this.ctx.lineWidth = 1;
                        this.ctx.beginPath();
                        this.ctx.arc(civ.x, civ.y, this.params.commDistance * civ.level, 0, Math.PI * 2);
                        this.ctx.stroke();
                    }
                });

                // 绘制飞船并移除已毁灭文明的飞船
                for (let i = this.civilizations.length - 1; i >= 0; i--) {
                    const civ = this.civilizations[i];
                    if (!civ.alive) {
                        // 如果文明已经毁灭，则移除其所有飞船及其轨迹
                        civ.ships = [];
                        continue;
                    }
                    civ.ships.forEach(ship => {
                        this.ctx.fillStyle = ship.getColor();
                        this.ctx.beginPath();
                        this.ctx.arc(ship.x, ship.y, 2, 0, Math.PI * 2);
                        this.ctx.fill();
                    });
                }
            }

            animate() {
                this.update();
                this.render();
                requestAnimationFrame(() => this.animate());
            }
        }

        // 启动模拟器
        document.addEventListener('DOMContentLoaded', () => {
            new UniverseSimulator();
        });
    </script>
</body>
</html>
